<html>
    <head>
        <style>
            #console_id {
                width: 100%;
                height: 100%;
                margin: 0px;
                background-color: black;
                color: whitesmoke;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <textarea id="console_id" disabled="disabled"></textarea>
        <script src="wasm/debug/stapel.js" async></script>
        <script>

            const STAPEL_DEST_FILE = "/home/web_user/test.st";

            document.ii = null;

            document.addEventListener("keyup",function(e){
                console.log("sending ",e.key.charCodeAt(0));
                _setKbbuf(e.key.charCodeAt(0));
            });

            window.loadCardridge = function(args,val){
                if(document.ii!=null){
                    return;
                }
                document.getElementById("console_id").value = "";
                if(FS.findObject(STAPEL_DEST_FILE)!=null){
                    FS.unlink(STAPEL_DEST_FILE);
                }
                FS.writeFile(STAPEL_DEST_FILE,val);
                out = function(evt){
                    document.getElementById("console_id").value += evt + "\n";
                };
                var res = callMain(args);
                if(res==0){
                    document.ii = window.setInterval(function(){
                        if(_handle_default_next_instruction()==0){
                            window.clearInterval(document.ii);
                            console.log("Program finished");
                            return;
                        }
                    },100);
                }
            };

            window.getCompiledFile = function(){
                return FS.readFile(STAPEL_DEST_FILE);
            };

            window.getErrorMessages = function(){
                return document.getElementById("console_id").value;
            };
        </script>
    </body>
</html>